stages:
  - sonarqube-check
  - sonarqube-vulnerability-report
  - build
  - release
  - sentry

variables:
  SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"  # Defines the location of the analysis task cache
  GIT_DEPTH: "0"  # Tells git to fetch all the branches of the project, required by the analysis task
  GIT_STRATEGY: fetch  # Tells git to fetch changes
  CONTAINER_BASE_IMAGE_NAME: $CI_REGISTRY/dnum/eplouribousse-frontend
  CONTAINER_TEST_IMAGE: $CONTAINER_BASE_IMAGE_NAME:$CI_COMMIT_REF_NAME
  CONTAINER_RELEASE_IMAGE: $CONTAINER_BASE_IMAGE_NAME:$CI_COMMIT_TAG
  SENTRY_URL: "https://sentry.app.unistra.fr"
  SENTRY_ORG: "sentry"
  SENTRY_PROJECT: "eplouribousse-front"
  SENTRY_REPO: "di / eplouribousse / eplfront"

before_script:
  - if [ -z "$CI_COMMIT_TAG" ]; then
    export DOCKER_IMAGE_TAG="$CI_COMMIT_SHORT_SHA";
    else
    export DOCKER_IMAGE_TAG="$CI_COMMIT_TAG";
    fi
  - export DESTINATION="${CONTAINER_BASE_IMAGE_NAME}:${DOCKER_IMAGE_TAG}"

sonarqube-check:
  stage: sonarqube-check
  image:
    name: ${CI_DEPENDENCY_PROXY_DIRECT_GROUP_IMAGE_PREFIX}/sonarsource/sonar-scanner-cli:11
    entrypoint: [ "" ]
  script:
    - sonar-scanner -Dsonar.host.url="${SONAR_HOST_URL}"
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
    - if: $CI_COMMIT_BRANCH == 'main'
    - if: $CI_COMMIT_BRANCH == 'develop'

sonarqube-vulnerability-report:
  stage: sonarqube-vulnerability-report
  script:
    - 'curl -u "${SONAR_TOKEN}:" "${SONAR_HOST_URL}/api/issues/gitlab_sast_export?projectKey=di_eplouribousse_eplfront_b4c7b291-530f-4ebf-9335-72d3ccae9588&branch=${CI_COMMIT_BRANCH}&pullRequest=${CI_MERGE_REQUEST_IID}" -o gl-sast-sonar-report.json'
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
    - if: $CI_COMMIT_BRANCH == 'main'
    - if: $CI_COMMIT_BRANCH == 'develop'
  artifacts:
    expire_in: 1 day
    reports:
      sast: gl-sast-sonar-report.json

sentry-release:
  stage: sentry
  image: getsentry/sentry-cli:latest
  variables:
    SENTRY_AUTH_TOKEN: $SENTRY_AUTH_TOKEN
  script:
    - export SENTRY_RELEASE="epl-front@$DOCKER_IMAGE_TAG"
    - sentry-cli releases new -p "$SENTRY_PROJECT" "$SENTRY_RELEASE"
    - sentry-cli releases set-commits --ignore-missing --commit "$SENTRY_REPO@$CI_COMMIT_SHA" "$SENTRY_RELEASE"
    - sentry-cli releases finalize "$SENTRY_RELEASE"
  rules:
    - if: '$CI_COMMIT_TAG'
      when: always
  needs:
    - job: r:docker

.build-image:
  image:
    # gcr.io/kaniko-project/executor:v1.7.0-debug
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  script:
    - mkdir -p /kaniko/.docker
    - if [ ${CI_COMMIT_TAG} ]; then
      echo "SENTRY_RELEASE_VERSION=epl-front@${DOCKER_IMAGE_TAG}" > "${CI_PROJECT_DIR}/sentry-release.env";
      else
      touch "${CI_PROJECT_DIR}/sentry-release.env";
      fi
    - chmod 0644 "${CI_PROJECT_DIR}/sentry-release.env"
    - echo "{\"auths\":{\"${CI_REGISTRY}\":{\"auth\":\"$(printf "%s:%s" "${CI_REGISTRY_USER}" "${CI_REGISTRY_PASSWORD}" | base64 | tr -d '\n')\"}}}" > /kaniko/.docker/config.json
    - echo "${CI_PROJECT_DIR} ${CI_PROJECT_DIR_PATH} ${CI_REGISTRY} ${CI_REGISTRY_USER} ${LATEST_DESTINATION} ${DESTINATION} ${EXTRA_ARGS}"
    - >-
      /kaniko/executor
      --context "${CI_PROJECT_DIR}"
      --dockerfile "${CI_PROJECT_DIR}/Dockerfile"
      --registry-mirror quay.apps.mgmt.paas.unistra.fr/dnum
      $([ -n "${LATEST_DESTINATION}" ] && echo "--destination ${LATEST_DESTINATION}")
      --destination "${DESTINATION}" 
      ${EXTRA_ARGS}
  tags:
    - cluster
    - kubernetes

b:docker:
  extends: .build-image
  stage: build
  variables:
    DESTINATION: $CONTAINER_TEST_IMAGE
    LATEST_DESTINATION: ""
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop"'
      when: always

r:docker:
  extends: .build-image
  stage: release
  variables:
    DESTINATION: $CONTAINER_RELEASE_IMAGE
    LATEST_DESTINATION: "$CONTAINER_BASE_IMAGE_NAME:latest"
  rules:
    - if: '$CI_COMMIT_TAG'
      when: always
